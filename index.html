<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é±¼å¡˜å…»æ®–è®°å½•ä¸ç»Ÿè®¡ç³»ç»Ÿ</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }

    body {
      background: #f0f5f0;
      padding: 0.5rem;
      font-size: 1rem;
      color: #333;
    }

    .main-card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }

    .title {
      font-size: 1.6rem;
      font-weight: bold;
      margin: 1rem 0;
      text-align: center;
      color: #2c662d;
      position: relative;
      padding-bottom: 0.5rem;
    }

    .title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: #42b983;
      border-radius: 2px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      color: #444;
      font-weight: 600;
    }

    .date-select-group {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .date-select {
      flex: 1;
      min-width: 120px;
    }

    select, input, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }

    /* è°ƒæ•´æŠ•å–‚é‡è¾“å…¥æ¡†ï¼Œç¡®ä¿èƒ½æ˜¾ç¤ºä¸‰ä½æ•°å¤šä¸€ç‚¹ */
    .amount-input {
      width: 100%;
      font-size: 1.2rem;
      padding: 0.4rem 0.6rem; /* å‡å°‘å†…è¾¹è· */
      border: 1px solid #ddd;
      border-radius: 6px;
      min-width: 70px; /* åˆšå¥½æ˜¾ç¤ºä¸‰ä½æ•°å¤šä¸€ç‚¹ */
      max-width: 90px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
      text-align: center;
    }

    .number-input {
      -webkit-appearance: none;
      -moz-appearance: textfield;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #42b983;
      box-shadow: 0 0 0 3px rgba(66, 185, 131, 0.2);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      height: 50px;
      cursor: pointer;
    }

    .btn-group {
      display: flex;
      gap: 0.6rem;
      margin: 1.2rem 0;
      width: 100%;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      min-height: 48px;
      min-width: 100px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    #exportBtn { background: #2196f3; }
    .admin-btn { background: #e53935; }
    .confirm-btn { background: #43a047; }
    .cancel-btn { background: #757575; }
    .add-btn { background: #2196f3; }
    .delete-btn { background: #e53935; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    th, td {
      border: 2px solid #e0e0e0;
      padding: 0.5rem 0.3rem;
      text-align: center;
    }

    th {
      background: #e8f5e9;
      font-size: 1rem;
      font-weight: bold;
      color: #2c662d;
    }

    .record-table th:nth-child(1) { width: 40px; }
    .record-table th:nth-child(6) { width: 25%; } /* å¢åŠ æŸè€—åˆ—å®½åº¦ */
    .record-table th:nth-child(7) { width: 35%; } /* å¢åŠ ç”¨è¯è®°å½•åˆ—å®½åº¦ */

    /* è°ƒæ•´é¥²æ–™åˆ—å®½åº¦ï¼Œé€‚åº”ç¼©å°åçš„è¾“å…¥æ¡† */
    .record-table th:nth-child(2),
    .record-table th:nth-child(3),
    .record-table th:nth-child(4),
    .record-table th:nth-child(5) {
      width: 80px; /* ç¼©å°å®½åº¦ï¼Œé€‚åº”è¾“å…¥æ¡† */
    }

    .vertical-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .day-number {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      height: 100%;
    }

    .record-table td:nth-child(6),
    .record-table td:nth-child(7) {
      white-space: normal;
      vertical-align: middle;
      min-height: 60px;
      padding: 0.5rem;
    }

    .table-container {
      margin: 1.2rem 0;
      border: 2px solid #e8f5e9;
      padding: 0.8rem;
      border-radius: 10px;
      overflow: hidden;
      background: #fafefa;
      min-height: 100px;
      display: flex;
      flex-direction: column;
    }

    .table-placeholder {
      text-align: center;
      padding: 2rem 0;
      color: #999;
      font-style: italic;
    }

    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;
      flex-grow: 1;
    }

    .record-table, .stats-table, .monthly-table {
      min-width: 680px; /* å¢åŠ æœ€å°å®½åº¦ï¼Œç¡®ä¿è¡¨æ ¼æ˜¾ç¤ºæ­£å¸¸ */
    }

    .section-divider {
      height: 2px;
      background: linear-gradient(to right, transparent, #42b983, transparent);
      margin: 1.2rem 0;
    }

    .section-title {
      font-size: 1.3rem;
      color: #2c662d;
      margin: 1.2rem 0 0.8rem;
      font-weight: bold;
      padding-left: 0.5rem;
      border-left: 4px solid #42b983;
    }

    /* æŸè€—å’Œç”¨è¯è®°å½•è¾“å…¥æ¡†å»¶é•¿ä¸€åŠ */
    .loss-input, .medicine-input {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem;
      min-height: 60px;
      resize: vertical;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      min-width: 180px; /* åŸºç¡€å®½åº¦å¢åŠ  */
    }

    .status-message {
      padding: 0.7rem;
      border-radius: 6px;
      margin: 0.8rem 0;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .status-success {
      background: #e8f5e9;
      color: #2c662d;
      border: 1px solid #42b983;
    }
    
    .status-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    
    .status-warning {
      background: #fff8e1;
      color: #e65100;
      border: 1px solid #ffb74d;
    }

    .stats-panel {
      background: #f9fdf9;
      border-radius: 10px;
      padding: 1rem;
      margin: 1.2rem 0;
      border: 2px solid #e8f5e9;
      position: relative;
    }

    .stats-filters {
      background: white;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stats-results {
      margin-top: 1.2rem;
    }

    .stats-summary {
      margin-bottom: 1.5rem;
    }

    .stats-tabs {
      display: flex;
      margin-bottom: 0.8rem;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
      padding-bottom: 0.3rem;
    }

    .stats-tab {
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      font-weight: bold;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-size: 1rem;
      white-space: nowrap;
    }

    .stats-tab.active {
      color: #2c662d;
      border-bottom-color: #42b983;
    }

    .stats-tab-content {
      display: none;
    }

    .stats-tab-content.active {
      display: block;
    }

    .edit-lock-tooltip {
      position: relative;
    }

    .edit-lock-tooltip:hover:after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 0.4rem;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 5px;
    }

    .table-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    tr:hover {
      background-color: #f9fdf9;
    }

    .icon {
      width: 18px;
      height: 18px;
      display: inline-block;
      vertical-align: middle;
    }

    .auto-save-indicator {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: rgba(66, 185, 131, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .auto-save-indicator.visible {
      opacity: 1;
    }

    .current-data-info {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: #f5f9f5;
      border-radius: 6px;
    }

    .export-loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      display: none;
    }

    .export-guide {
      background: #f0f7ff;
      border-left: 4px solid #2196f3;
      padding: 0.8rem;
      margin: 1rem 0;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #3366cc;
    }

    .guide-title {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .guide-steps {
      padding-left: 1.2rem;
    }

    .guide-steps li {
      margin: 0.3rem 0;
    }

    /* ç»Ÿè®¡åŠ è½½æç¤º */
    .stats-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 10;
    }

    /* ç®¡ç†å‘˜åŠŸèƒ½æ ·å¼ */
    .admin-controls {
      margin: 1rem 0;
      padding: 1rem;
      background: #fff8e1;
      border-radius: 8px;
      display: none;
    }

    .admin-controls.visible {
      display: block;
    }

    .admin-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px dashed #ffb74d;
    }

    .admin-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .admin-section-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #e65100;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      display: none;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      padding: 1.5rem;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: #333;
      text-align: center;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
    }

    .login-form-group {
      margin-bottom: 1rem;
    }

    .login-form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    /* è®°å½•äººåˆ—è¡¨æ ·å¼ */
    .record-person-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .record-person-item {
      padding: 0.6rem 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
    }

    .record-person-item:last-child {
      border-bottom: none;
    }

    .delete-record-controls {
      display: flex;
      gap: 0.8rem;
      align-items: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .delete-record-controls .form-group {
      flex: 1;
      min-width: 120px;
    }

    .title-edit-container {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .title-edit-input {
      flex: 1;
    }

    /* ç®¡ç†å‘˜ç™»å½•/é€€å‡ºæŒ‰é’® */
    .admin-login-btn, .admin-logout-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      min-width: auto;
      white-space: nowrap;
    }

    .admin-logout-btn {
      background: #e53935;
      display: none;
    }

    .admin-logout-btn.visible {
      display: flex;
    }

    .danger-zone {
      background: #ffebee;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
    }

    .danger-zone-title {
      color: #c62828;
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .data-records-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .data-record-item {
      padding: 0.6rem 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
    }

    .data-record-item:last-child {
      border-bottom: none;
    }

    .record-info {
      text-align: left;
    }

    .record-date {
      font-size: 0.9rem;
      color: #666;
    }

    /* ç»Ÿä¸€å¹¶ç¼©çŸ­æ‰€æœ‰çº¢è‰²åˆ é™¤æŒ‰é’®çš„é•¿åº¦ */
    .delete-btn {
      width: 70px; /* å›ºå®šå®½åº¦ï¼Œç¡®ä¿æ‰€æœ‰æŒ‰é’®é•¿åº¦ä¸€è‡´ */
      min-width: 70px; /* å›ºå®šæœ€å°å®½åº¦ */
      padding: 0.2rem 0.3rem; /* å‡å°‘å†…è¾¹è· */
      font-size: 0.8rem; /* é€‚å½“è°ƒæ•´å­—ä½“å¤§å° */
      white-space: nowrap;
      flex: none !important; /* å¼ºåˆ¶ä¸ä¼¸ç¼© */
    }

    /* è®°å½•äººåˆ—è¡¨ä¸­çš„åˆ é™¤æŒ‰é’®é¢å¤–è°ƒæ•´ */
    .record-person-item .delete-btn {
      width: 60px;
      min-width: 60px;
    }

    /* ç‰¹æ®Šè°ƒæ•´"ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•æ•°æ®"æŒ‰é’®å®½åº¦ */
    .delete-all-btn {
      width: auto !important;
      min-width: 160px !important;
      padding: 0.3rem 0.8rem !important;
    }

    /* å‘¼å¸æ•ˆæœåŠ¨ç”» */
    @keyframes breathing {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    .editing-breathing-bg {
      animation: breathing 1.5s ease-in-out infinite;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
      .main-card {
        padding: 0.8rem;
      }

      .title {
        font-size: 1.4rem;
        margin: 1.5rem 0 1rem 0;
      }

      .admin-login-btn, .admin-logout-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        top: 0.8rem;
        right: 0.8rem;
      }

      .admin-controls {
        padding: 0.8rem;
        margin: 0.8rem 0;
      }

      .admin-section {
        margin-bottom: 1rem;
        padding-bottom: 0.8rem;
      }

      .admin-section-title {
        font-size: 1rem;
        margin-bottom: 0.6rem;
      }

      .form-group {
        margin-bottom: 0.8rem;
      }

      .form-group label {
        font-size: 1rem;
        margin-bottom: 0.3rem;
      }

      button {
        padding: 0.6rem;
        font-size: 0.9rem;
        min-height: auto;
      }

      .record-person-item, .data-record-item {
        padding: 0.5rem 0.6rem;
      }

      .record-person-item span, .data-record-item .record-info {
        font-size: 0.9rem;
      }

      /* æ‰‹æœºç«¯åˆ é™¤æŒ‰é’®è¿›ä¸€æ­¥ç¼©çŸ­ */
      .delete-btn {
        width: 50px;
        min-width: 50px;
        padding: 0.1rem 0.2rem;
        font-size: 0.7rem;
      }

      /* è®°å½•äººåˆ—è¡¨ä¸­çš„åˆ é™¤æŒ‰é’®åœ¨æ‰‹æœºç«¯ */
      .record-person-item .delete-btn {
        width: 45px;
        min-width: 45px;
      }

      /* æ‰‹æœºç«¯"ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•æ•°æ®"æŒ‰é’®è°ƒæ•´ */
      .delete-all-btn {
        min-width: 140px !important;
        font-size: 0.75rem !important;
      }

      .title-edit-container {
        flex-direction: column;
        gap: 0.6rem;
      }

      .title-edit-input {
        width: 100%;
      }

      .delete-record-controls {
        gap: 0.6rem;
      }

      /* æ‰‹æœºç«¯è¾“å…¥æ¡†è¿›ä¸€æ­¥ä¼˜åŒ– */
      .amount-input {
        min-width: 60px;
        max-width: 80px;
        padding: 0.3rem 0.5rem;
        font-size: 1rem;
      }
      
      .loss-input, .medicine-input {
        min-width: 140px;
        font-size: 0.9rem;
        padding: 0.4rem;
      }
    }

    @media (max-width: 480px) {
      .admin-section-title {
        font-size: 0.95rem;
      }

      .danger-zone-title {
        font-size: 0.95rem;
      }

      .danger-zone p {
        font-size: 0.85rem;
      }

      .admin-login-btn span, .admin-logout-btn span {
        display: none;
      }

      .admin-login-btn, .admin-logout-btn {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 50%;
        justify-content: center;
      }

      .modal {
        padding: 1rem;
      }

      .modal-title {
        font-size: 1.1rem;
      }
    }
  </style>
</head>

<body>
  <div class="main-card">
    <h1 class="title" id="systemTitle">é±¼å¡˜å…»æ®–è®°å½•ä¸ç»Ÿè®¡ç³»ç»Ÿ</h1>

    <!-- ç®¡ç†å‘˜ç™»å½•/é€€å‡ºæŒ‰é’® -->
    <button class="admin-login-btn" id="adminLoginBtn" onclick="showAdminLoginModal()">
      <i class="fas fa-lock"></i> <span>ç®¡ç†å‘˜</span>
    </button>
    <button class="admin-logout-btn" id="adminLogoutBtn" onclick="adminLogout()">
      <i class="fas fa-sign-out-alt"></i> <span>é€€å‡º</span>
    </button>

    <div id="statusMessage" class="status-message"></div>

    <!-- å¯¼å‡ºæ–‡ä»¶æŒ‡å¼•ï¼ˆæ‰‹æœºç”¨æˆ·å¯è§ï¼‰ -->
    <div class="export-guide" id="exportGuide" style="display: none;">
      <div class="guide-title">ğŸ“± æ‰‹æœºæ–‡ä»¶æŸ¥æ‰¾æŒ‡å¼•ï¼š</div>
      <ul class="guide-steps">
        <li>1. å¯¼å‡ºçš„æ–‡ä»¶ä¿å­˜åœ¨"ä¸‹è½½"æ–‡ä»¶å¤¹ä¸­</li>
        <li>2. å¯é€šè¿‡"æ–‡ä»¶ç®¡ç†"APP â†’ "ä¸‹è½½"ç›®å½•æŸ¥æ‰¾</li>
        <li>3. éƒ¨åˆ†æ‰‹æœºå¯åœ¨"æˆ‘çš„æ–‡ä»¶" â†’ "ä¸‹è½½"ä¸­æŸ¥çœ‹</li>
      </ul>
    </div>

    <!-- ç®¡ç†å‘˜æ§åˆ¶é¢æ¿ -->
    <div class="admin-controls" id="adminControls">
      <div class="admin-section">
        <div class="admin-section-title">
          <i class="fas fa-user-cog"></i> è®°å½•äººç®¡ç†
        </div>
        <div class="form-group">
          <label for="newRecorderName">æ·»åŠ æ–°è®°å½•äºº</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="newRecorderName" placeholder="è¾“å…¥æ–°è®°å½•äººå§“å">
            <button class="add-btn" style="flex: none; min-width: auto; padding: 0 1rem;" onclick="addRecorder()">
              <i class="fas fa-plus"></i> æ·»åŠ 
            </button>
          </div>
        </div>
        <div class="record-person-list" id="recordPersonList">
          <!-- è®°å½•äººåˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-section-title">
          <i class="fas fa-heading"></i> ç³»ç»Ÿæ ‡é¢˜è®¾ç½®
        </div>
        <div class="title-edit-container">
          <input type="text" id="newSystemTitle" class="title-edit-input" placeholder="è¾“å…¥æ–°çš„ç³»ç»Ÿæ ‡é¢˜">
          <button class="confirm-btn" onclick="updateSystemTitle()">
            <i class="fas fa-save"></i> ä¿å­˜
          </button>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-section-title">
          <i class="fas fa-database"></i> è®°å½•æ•°æ®ç®¡ç†
        </div>
        <div class="form-group">
          <label>åˆ é™¤ç‰¹å®šè®°å½•</label>
          <div class="delete-record-controls">
            <div class="form-group">
              <select id="deletePondSelect">
                <option value="">é€‰æ‹©å¡˜å£</option>
                <option value="1å·å¤§å¡˜">1å·å¤§å¡˜</option>
                <option value="2å·å¤§å¡˜">2å·å¤§å¡˜</option>
                <option value="3å·å¤§å¡˜">3å·å¤§å¡˜</option>
                <option value="4å·å¤§å¡˜">4å·å¤§å¡˜</option>
                <option value="5å·å¤§å¡˜">5å·å¤§å¡˜</option>
                <option value="1å·å°å¡˜">1å·å°å¡˜</option>
                <option value="2å·å°å¡˜">2å·å°å¡˜</option>
                <option value="4å·å°å¡˜">4å·å°å¡˜</option>
                <option value="5å·å°å¡˜">5å·å°å¡˜</option>
                <option value="ä¸œä¸‰åäº©">ä¸œä¸‰åäº©</option>
                <option value="è¥¿ä¸‰åäº©">è¥¿ä¸‰åäº©</option>
              </select>
            </div>
            <div class="form-group">
              <select id="deleteYearSelect">
                <!-- å¹´ä»½é€‰é¡¹åŠ¨æ€ç”Ÿæˆ -->
              </select>
            </div>
            <div class="form-group">
              <select id="deleteMonthSelect">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>
            <button class="delete-btn" style="flex: none;" onclick="deleteSpecificRecord()">
              <i class="fas fa-trash"></i> åˆ é™¤
            </button>
          </div>
        </div>

        <div class="danger-zone">
          <div class="danger-zone-title">
            <i class="fas fa-exclamation-triangle"></i> å±é™©æ“ä½œ
          </div>
          <button class="delete-btn delete-all-btn" onclick="showDeleteAllConfirm()">
            <i class="fas fa-trash-alt"></i> ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•æ•°æ®
          </button>
          <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #c62828;">
            è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ç³»ç»Ÿä¸­æ‰€æœ‰è®°å½•çš„æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
          </p>
        </div>

        <div style="margin-top: 1rem;">
          <label>ç°æœ‰è®°å½•åˆ—è¡¨</label>
          <div class="data-records-list" id="dataRecordsList">
            <!-- æ•°æ®è®°å½•åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <div class="current-data-info" id="currentDataInfo">
      æ­£åœ¨æŸ¥çœ‹ï¼š<span id="currentPondText">æœªé€‰æ‹©å¡˜å£</span> Â· <span id="currentDateText">2025å¹´8æœˆ</span>
    </div>

    <div class="section-title">è®°å½•ç®¡ç†</div>
    
    <div class="form-group">
      <label>é€‰æ‹©è®°å½•å¹´æœˆ</label>
      <div class="date-select-group">
        <select id="recordYearSelect" class="date-select" onchange="handleYearMonthChange()">
          <!-- å¹´ä»½é€‰é¡¹åŠ¨æ€ç”Ÿæˆ -->
        </select>
        <select id="recordMonthSelect" class="date-select" onchange="handleYearMonthChange()">
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>è®°å½•äºº</label>
      <select id="recorder" onchange="scheduleAutoSave()">
        <option value="">è¯·é€‰æ‹©</option>
        <!-- è®°å½•äººé€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </select>
    </div>

    <div class="form-group">
      <label>å¡˜å£ <span style="color: #e65100; font-size: 0.9rem;">(åˆ‡æ¢å¡˜å£å°†åŠ è½½å¯¹åº”æ•°æ®)</span></label>
      <select id="pond" onchange="handlePondChange()">
        <option value="">è¯·é€‰æ‹©</option>
        <option value="1å·å¤§å¡˜">1å·å¤§å¡˜</option>
        <option value="2å·å¤§å¡˜">2å·å¤§å¡˜</option>
        <option value="3å·å¤§å¡˜">3å·å¤§å¡˜</option>
        <option value="4å·å¤§å¡˜">4å·å¤§å¡˜</option>
        <option value="5å·å¤§å¡˜">5å·å¤§å¡˜</option>
        <option value="1å·å°å¡˜">1å·å°å¡˜</option>
        <option value="2å·å°å¡˜">2å·å°å¡˜</option>
        <option value="4å·å°å¡˜">4å·å°å¡˜</option>
        <option value="5å·å°å¡˜">5å·å°å¡˜</option>
        <option value="ä¸œä¸‰åäº©">ä¸œä¸‰åäº©</option>
        <option value="è¥¿ä¸‰åäº©">è¥¿ä¸‰åäº©</option>
      </select>
    </div>

    <div class="btn-group">
      <button id="exportBtn" onclick="exportToExcel()">
        <i class="fas fa-file-export"></i>
        å¯¼å‡ºè®°å½•
      </button>
    </div>

    <div class="table-container">
      <div class="table-scroll">
        <table id="recordTable" class="record-table">
          <thead>
            <tr>
              <th><div class="vertical-text">æ—¥<br>æœŸ</div></th>
              <th><div class="vertical-text">é¢—<br>ç²’</div></th>
              <th><div class="vertical-text">è†¨<br>åŒ–</div></th>
              <th><div class="vertical-text">å‘<br>é…µ</div></th>
              <th><div class="vertical-text">ç²‰<br>æ–™</div></th>
              <th>æŸè€—</th>
              <th>ç”¨è¯è®°å½•</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- è¡¨æ ¼å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
        <div id="tablePlaceholder" class="table-placeholder">è¯·é€‰æ‹©å¡˜å£å’Œå¹´æœˆä»¥æ˜¾ç¤ºè®°å½•è¡¨æ ¼</div>
      </div>
    </div>

    <div class="section-divider"></div>

    <div class="section-title">æ•°æ®ç»Ÿè®¡åˆ†æ</div>
    
    <div class="stats-panel">
      <!-- ç»Ÿè®¡åŠ è½½æç¤º -->
      <div class="stats-loading" id="statsLoading">
        <div>æ­£åœ¨æ›´æ–°ç»Ÿè®¡æ•°æ®...</div>
      </div>

      <div class="stats-filters">
        <div class="form-group">
          <label>é€‰æ‹©ç»Ÿè®¡æ¡ä»¶</label>
          <select id="statsPondSelect" class="date-select" style="margin-bottom: 1rem;">
            <option value="">æ‰€æœ‰å¡˜å£</option>
            <option value="1å·å¤§å¡˜">1å·å¤§å¡˜</option>
            <option value="2å·å¤§å¡˜">2å·å¤§å¡˜</option>
            <option value="3å·å¤§å¡˜">3å·å¤§å¡˜</option>
            <option value="4å·å¤§å¡˜">4å·å¤§å¡˜</option>
            <option value="5å·å¤§å¡˜">5å·å¤§å¡˜</option>
            <option value="1å·å°å¡˜">1å·å°å¡˜</option>
            <option value="2å·å°å¡˜">2å·å°å¡˜</option>
            <option value="4å·å°å¡˜">4å·å°å¡˜</option>
            <option value="5å·å°å¡˜">5å·å°å¡˜</option>
            <option value="ä¸œä¸‰åäº©">ä¸œä¸‰åäº©</option>
            <option value="è¥¿ä¸‰åäº©">è¥¿ä¸‰åäº©</option>
          </select>
          
          <label>é€‰æ‹©ç»Ÿè®¡æ—¶é—´æ®µ</label>
          <div class="date-select-group">
            <div class="date-select">
              <label style="font-size: 1rem; margin-bottom: 0.3rem;">å¼€å§‹å¹´æœˆ</label>
              <select id="startYearSelect" class="date-select">
                <!-- å¹´ä»½é€‰é¡¹åŠ¨æ€ç”Ÿæˆ -->
              </select>
            </div>
            <div class="date-select">
              <label style="font-size: 1rem; margin-bottom: 0.3rem;">&nbsp;</label>
              <select id="startMonthSelect" class="date-select">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>
          </div>
          
          <div class="date-select-group">
            <div class="date-select">
              <label style="font-size: 1rem; margin-bottom: 0.3rem;">ç»“æŸå¹´æœˆ</label>
              <select id="endYearSelect" class="date-select">
                <!-- å¹´ä»½é€‰é¡¹åŠ¨æ€ç”Ÿæˆ -->
              </select>
            </div>
            <div class="date-select">
              <label style="font-size: 1rem; margin-bottom: 0.3rem;">&nbsp;</label>
              <select id="endMonthSelect" class="date-select">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-results">
        <!-- ç»Ÿè®¡æ ‡ç­¾é¡µ -->
        <div class="stats-tabs">
          <div class="stats-tab active" data-tab="feed-summary">æŠ•å–‚é‡æ±‡æ€»</div>
          <div class="stats-tab" data-tab="pond-feed-type">å¡˜å£-é¥²æ–™ç§ç±»</div>
          <div class="stats-tab" data-tab="loss-by-breed">é±¼ç±»æŸè€—ç»Ÿè®¡</div>
          <div class="stats-tab" data-tab="pond-loss-type">å¡˜å£-é±¼ç±»æŸè€—</div>
          <div class="stats-tab" data-tab="monthly-detail">æœˆåº¦æ˜ç»†</div>
        </div>

        <!-- 1. æŠ•å–‚é‡æ±‡æ€» -->
        <div class="stats-tab-content active" id="feed-summary">
          <div class="stats-summary">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.8rem; color: #2c662d;">æŠ•å–‚é‡ç»Ÿè®¡æ±‡æ€»</h3>
            <div class="table-scroll">
              <table class="stats-table">
                <thead>
                  <tr>
                    <th>ç»Ÿè®¡é¡¹</th>
                    <th>é¢—ç²’é¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>è†¨åŒ–é¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>å‘é…µé¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>ç²‰æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>æ€»è®¡ï¼ˆåŒ…ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="totalStatsBody">
                  <tr>
                    <td>æ€»æŠ•å–‚é‡</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                    <td>0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 2. æŒ‰å¡˜å£-é¥²æ–™ç§ç±»ç»Ÿè®¡ -->
        <div class="stats-tab-content" id="pond-feed-type">
          <div class="stats-summary">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.8rem; color: #2c662d;">å„å¡˜å£é¥²æ–™ç§ç±»ç”¨é‡ç»Ÿè®¡</h3>
            <div class="table-scroll">
              <table class="stats-table">
                <thead>
                  <tr>
                    <th>å¡˜å£</th>
                    <th>é¢—ç²’é¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>è†¨åŒ–é¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>å‘é…µé¥²æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>ç²‰æ–™ï¼ˆåŒ…ï¼‰</th>
                    <th>æ€»è®¡ï¼ˆåŒ…ï¼‰</th>
                  </tr>
                </thead>
                <tbody id="pondFeedTypeBody">
                  <tr>
                    <td>æš‚æ— æ•°æ®</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 3. é±¼ç±»æŸè€—æ€»ç»Ÿè®¡ -->
        <div class="stats-tab-content" id="loss-by-breed">
          <div class="stats-summary">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.8rem; color: #2c662d;">é±¼ç±»æŸè€—æ€»ç»Ÿè®¡</h3>
            <div class="table-scroll">
              <table class="stats-table">
                <thead>
                  <tr>
                    <th>é±¼ç±»å“ç§</th>
                    <th>ç´¯è®¡æ•°é‡</th>
                    <th>ä¸»è¦åŸå› </th>
                    <th>å æ¯”</th>
                    <th>æ¶‰åŠå¡˜å£</th>
                  </tr>
                </thead>
                <tbody id="lossByBreedBody">
                  <tr>
                    <td>æš‚æ— æ•°æ®</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 4. æŒ‰å¡˜å£-é±¼ç±»ç§ç±»æŸè€—ç»Ÿè®¡ -->
        <div class="stats-tab-content" id="pond-loss-type">
          <div class="stats-summary">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.8rem; color: #2c662d;">å„å¡˜å£é±¼ç±»æŸè€—ç»Ÿè®¡</h3>
            <div class="table-scroll">
              <table class="stats-table">
                <thead>
                  <tr>
                    <th>å¡˜å£</th>
                    <th>è‰é±¼</th>
                    <th>é²«é±¼</th>
                    <th>é®°é±¼</th>
                    <th>é»„é‡‘é²«</th>
                    <th>ä¹Œé’</th>
                    <th>èŠ±é²¢</th>
                    <th>ç™½é²¢</th>
                    <th>é²»é±¼</th>
                    <th>è™¾</th>
                    <th>æ€»è®¡</th>
                  </tr>
                </thead>
                <tbody id="pondLossTypeBody">
                  <tr>
                    <td>æš‚æ— æ•°æ®</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 5. æœˆåº¦æ˜ç»† -->
        <div class="stats-tab-content" id="monthly-detail">
          <div class="stats-summary">
            <h3 style="font-size: 1.2rem; margin-bottom: 0.8rem; color: #2c662d;">æœˆåº¦ç»Ÿè®¡æ˜ç»†</h3>
            <div class="table-scroll">
              <table class="monthly-table">
                <thead>
                  <tr>
                    <th>æœˆä»½/å¡˜å£</th>
                    <th>æ€»æŠ•å–‚é‡ï¼ˆåŒ…ï¼‰</th>
                    <th>å¹³å‡æ¯æ—¥æŠ•å–‚ï¼ˆåŒ…ï¼‰</th>
                    <th>æ€»æŸè€—æ•°é‡</th>
                    <th>ç”¨è¯æ¬¡æ•°</th>
                  </tr>
                </thead>
                <tbody id="monthlyStatsBody">
                  <tr>
                    <td>æš‚æ— æ•°æ®</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è‡ªåŠ¨ä¿å­˜æç¤º -->
  <div id="autoSaveIndicator" class="auto-save-indicator">æ•°æ®å·²è‡ªåŠ¨ä¿å­˜</div>
  
  <!-- å¯¼å‡ºåŠ è½½æç¤º -->
  <div class="export-loading" id="exportLoading">
    <div>æ­£åœ¨å¯¼å‡ºæ•°æ®ï¼Œè¯·ç¨å€™...</div>
  </div>

  <!-- ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="adminLoginModal">
    <div class="modal">
      <div class="modal-title">ç®¡ç†å‘˜ç™»å½•</div>
      <div class="modal-body">
        <div class="login-form-group">
          <label for="adminPassword">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </label>
          <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
        </div>
        <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
          æç¤ºï¼šé»˜è®¤å¯†ç ä¸º"admin123"ï¼Œå»ºè®®ç™»å½•åæ›´æ¢å¯†ç ï¼ˆåŠŸèƒ½å¼€å‘ä¸­ï¼‰
        </p>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="hideAdminLoginModal()">å–æ¶ˆ</button>
        <button class="confirm-btn" onclick="adminLogin()">ç™»å½•</button>
      </div>
    </div>
  </div>

  <!-- ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="deleteAllConfirmModal">
    <div class="modal">
      <div class="modal-title" style="color: #c62828;">
        <i class="fas fa-exclamation-circle"></i> ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®
      </div>
      <div class="modal-body">
        <p>æ‚¨ç¡®å®šè¦åˆ é™¤ç³»ç»Ÿä¸­æ‰€æœ‰çš„è®°å½•æ•°æ®å—ï¼Ÿ</p>
        <p style="color: #c62828; margin-top: 1rem; font-weight: bold;">
          æ­¤æ“ä½œä¸å¯é€†ï¼Œæ‰€æœ‰è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ— æ³•æ¢å¤ï¼
        </p>
        <div style="margin-top: 1rem;">
          <label for="confirmDeleteText">è¯·è¾“å…¥"DELETE"ç¡®è®¤æ­¤æ“ä½œ</label>
          <input type="text" id="confirmDeleteText" placeholder="è¾“å…¥DELETE">
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="hideDeleteAllConfirmModal()">å–æ¶ˆ</button>
        <button class="delete-btn" onclick="deleteAllRecords()">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const currentYear = new Date().getFullYear();
    let currentData = null;
    let lastModifiedTimes = {};
    let editClickCount = {};
    let saveTimeout = null;
    let isLoading = false;
    let statsDebounceTimer = null;
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    let isAdminLoggedIn = false;
    // é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼ˆå®é™…åº”ç”¨ä¸­åº”åŠ å¯†å­˜å‚¨ï¼‰
    const ADMIN_PASSWORD = "admin123";

    window.onload = function() {
      // æ‰‹æœºç«¯æ˜¾ç¤ºå¯¼å‡ºæŒ‡å¼•
      if (isMobile) {
        document.getElementById('exportGuide').style.display = 'block';
      }

      // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©æ¡†
      const yearSelects = ['recordYearSelect', 'startYearSelect', 'endYearSelect', 'deleteYearSelect'];
      yearSelects.forEach(id => {
        const select = document.getElementById(id);
        for (let y = 2020; y <= currentYear; y++) {
          const option = document.createElement('option');
          option.value = y;
          option.textContent = y + 'å¹´';
          if (y === currentYear) option.selected = true;
          select.appendChild(option);
        }
      });
      
      // è®¾ç½®å½“å‰æœˆä»½
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('recordMonthSelect').value = currentMonth;
      document.getElementById('startMonthSelect').value = currentMonth;
      document.getElementById('endMonthSelect').value = currentMonth;
      document.getElementById('deleteMonthSelect').value = currentMonth;
      
      // åˆå§‹åŒ–è®°å½•äººåˆ—è¡¨
      initRecorders();
      
      // ç»‘å®šç»Ÿè®¡æ ‡ç­¾äº‹ä»¶
      bindStatsTabEvents();
      
      // ç»‘å®šå®æ—¶ç»Ÿè®¡äº‹ä»¶
      bindRealTimeStatsEvents();
      
      // æ›´æ–°å½“å‰æ•°æ®æ ‡è¯†
      updateCurrentDataInfo();
      
      // åˆå§‹åŒ–è¡¨æ ¼æ˜¾ç¤ºçŠ¶æ€
      updateTableVisibility(false);

      // é¡µé¢åŠ è½½åè‡ªåŠ¨è§¦å‘ä¸€æ¬¡ç»Ÿè®¡
      setTimeout(() => {
        calculateStatistics();
      }, 500);

      // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
      checkAdminLoginStatus();

      // æ£€æŸ¥SheetJSåº“æ˜¯å¦åŠ è½½æˆåŠŸ
      if (typeof XLSX === 'undefined') {
        showStatus('å¯¼å‡ºåŠŸèƒ½ä¾èµ–çš„åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        document.getElementById('exportBtn').disabled = true;
        document.getElementById('exportBtn').style.opacity = '0.6';
      }
    };

    // åˆå§‹åŒ–è®°å½•äººåˆ—è¡¨
    function initRecorders() {
      // ä»localStorageè·å–è®°å½•äººï¼Œå¦‚æ— åˆ™ä½¿ç”¨é»˜è®¤å€¼
      let recorders = JSON.parse(localStorage.getItem('recorders')) || [
        "ç‹ç«‹æ–°", "å­™å…‹å¢", "è€å‘¨", "è€è”¡", "è‘›éŸ¶å¹´", "å­™å"
      ];
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('recorders', JSON.stringify(recorders));
      
      // æ›´æ–°è®°å½•äººé€‰æ‹©æ¡†
      updateRecorderSelect(recorders);
      
      // æ›´æ–°ç®¡ç†å‘˜é¡µé¢çš„è®°å½•äººåˆ—è¡¨
      updateRecorderList(recorders);
    }

    // æ›´æ–°è®°å½•äººé€‰æ‹©æ¡†
    function updateRecorderSelect(recorders) {
      const recorderSelect = document.getElementById('recorder');
      // ä¿ç•™"è¯·é€‰æ‹©"é€‰é¡¹ï¼Œæ¸…é™¤å…¶ä»–é€‰é¡¹
      while (recorderSelect.options.length > 1) {
        recorderSelect.remove(1);
      }
      
      // æ·»åŠ è®°å½•äººé€‰é¡¹
      recorders.forEach(recorder => {
        const option = document.createElement('option');
        option.value = recorder;
        option.textContent = recorder;
        recorderSelect.appendChild(option);
      });
    }

    // æ›´æ–°ç®¡ç†å‘˜é¡µé¢çš„è®°å½•äººåˆ—è¡¨
    function updateRecorderList(recorders) {
      const listContainer = document.getElementById('recordPersonList');
      listContainer.innerHTML = '';
      
      if (recorders.length === 0) {
        listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #999;">æš‚æ— è®°å½•äºº</div>';
        return;
      }
      
      recorders.forEach(recorder => {
        const item = document.createElement('div');
        item.className = 'record-person-item';
        item.innerHTML = `
          <span>${recorder}</span>
          <button class="delete-btn editing-breathing-bg" 
                  onclick="deleteRecorder('${escape(recorder)}')">
            <i class="fas fa-times"></i> åˆ é™¤
          </button>
        `;
        listContainer.appendChild(item);
      });
    }

    // æ·»åŠ æ–°è®°å½•äºº
    function addRecorder() {
      const newRecorderInput = document.getElementById('newRecorderName');
      const newRecorder = newRecorderInput.value.trim();
      
      if (!newRecorder) {
        showStatus('è¯·è¾“å…¥è®°å½•äººå§“å', 'warning');
        return;
      }
      
      let recorders = JSON.parse(localStorage.getItem('recorders')) || [];
      
      if (recorders.includes(newRecorder)) {
        showStatus('è¯¥è®°å½•äººå·²å­˜åœ¨', 'warning');
        return;
      }
      
      recorders.push(newRecorder);
      localStorage.setItem('recorders', JSON.stringify(recorders));
      
      // æ›´æ–°ç•Œé¢
      updateRecorderSelect(recorders);
      updateRecorderList(recorders);
      
      newRecorderInput.value = '';
      showStatus(`å·²æ·»åŠ è®°å½•äººï¼š${newRecorder}`, 'success');
    }

    // åˆ é™¤è®°å½•äºº
    function deleteRecorder(encodedRecorder) {
      const recorder = unescape(encodedRecorder);
      let recorders = JSON.parse(localStorage.getItem('recorders')) || [];
      
      // è‡³å°‘ä¿ç•™ä¸€ä¸ªè®°å½•äºº
      if (recorders.length <= 1) {
        showStatus('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè®°å½•äºº', 'warning');
        return;
      }
      
      const newRecorders = recorders.filter(r => r !== recorder);
      localStorage.setItem('recorders', JSON.stringify(newRecorders));
      
      // æ›´æ–°ç•Œé¢
      updateRecorderSelect(newRecorders);
      updateRecorderList(newRecorders);
      
      showStatus(`å·²åˆ é™¤è®°å½•äººï¼š${recorder}`, 'success');
    }

    // æ›´æ–°ç³»ç»Ÿæ ‡é¢˜
    function updateSystemTitle() {
      const newTitleInput = document.getElementById('newSystemTitle');
      const newTitle = newTitleInput.value.trim();
      
      if (!newTitle) {
        showStatus('è¯·è¾“å…¥ç³»ç»Ÿæ ‡é¢˜', 'warning');
        return;
      }
      
      // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
      document.getElementById('systemTitle').textContent = newTitle;
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('systemTitle', newTitle);
      
      newTitleInput.value = '';
      showStatus('ç³»ç»Ÿæ ‡é¢˜å·²æ›´æ–°', 'success');
    }

    // æ˜¾ç¤ºç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
    function showAdminLoginModal() {
      document.getElementById('adminLoginModal').classList.add('visible');
      document.getElementById('adminPassword').focus();
    }

    // éšè—ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
    function hideAdminLoginModal() {
      document.getElementById('adminLoginModal').classList.remove('visible');
      document.getElementById('adminPassword').value = '';
    }

    // ç®¡ç†å‘˜ç™»å½•
    function adminLogin() {
      const passwordInput = document.getElementById('adminPassword');
      const password = passwordInput.value.trim();
      
      if (password === ADMIN_PASSWORD) {
        // ç™»å½•æˆåŠŸ
        isAdminLoggedIn = true;
        localStorage.setItem('adminLoggedIn', 'true');
        
        // æ›´æ–°ç•Œé¢
        document.getElementById('adminLoginModal').classList.remove('visible');
        document.getElementById('adminLoginBtn').style.display = 'none';
        document.getElementById('adminLogoutBtn').classList.add('visible');
        document.getElementById('adminControls').classList.add('visible');
        
        // åŠ è½½ç°æœ‰æ•°æ®è®°å½•åˆ—è¡¨
        loadDataRecordsList();
        
        // å¡«å……å½“å‰æ ‡é¢˜åˆ°è¾“å…¥æ¡†
        const currentTitle = document.getElementById('systemTitle').textContent;
        document.getElementById('newSystemTitle').value = currentTitle;
        
        showStatus('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ', 'success');
      } else {
        showStatus('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
        passwordInput.focus();
      }
    }

    // ç®¡ç†å‘˜é€€å‡ºç™»å½•
    function adminLogout() {
      isAdminLoggedIn = false;
      localStorage.removeItem('adminLoggedIn');
      
      // æ›´æ–°ç•Œé¢
      document.getElementById('adminLoginBtn').style.display = 'flex';
      document.getElementById('adminLogoutBtn').classList.remove('visible');
      document.getElementById('adminControls').classList.remove('visible');
      
      showStatus('å·²é€€å‡ºç®¡ç†å‘˜ç™»å½•', 'success');
    }

    // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
    function checkAdminLoginStatus() {
      const savedStatus = localStorage.getItem('adminLoggedIn');
      if (savedStatus === 'true') {
        isAdminLoggedIn = true;
        document.getElementById('adminLoginBtn').style.display = 'none';
        document.getElementById('adminLogoutBtn').classList.add('visible');
        document.getElementById('adminControls').classList.add('visible');
        
        // åŠ è½½ç°æœ‰æ•°æ®è®°å½•åˆ—è¡¨
        loadDataRecordsList();
        
        // å¡«å……å½“å‰æ ‡é¢˜åˆ°è¾“å…¥æ¡†
        const currentTitle = document.getElementById('systemTitle').textContent;
        document.getElementById('newSystemTitle').value = currentTitle;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ ‡é¢˜
      const savedTitle = localStorage.getItem('systemTitle');
      if (savedTitle) {
        document.getElementById('systemTitle').textContent = savedTitle;
      }
    }

    // åŠ è½½ç°æœ‰æ•°æ®è®°å½•åˆ—è¡¨
    function loadDataRecordsList() {
      const listContainer = document.getElementById('dataRecordsList');
      listContainer.innerHTML = '';
      
      let hasRecords = false;
      
      // éå†localStorageä¸­çš„æ‰€æœ‰è®°å½•
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        // è¯†åˆ«è®°å½•æ•°æ®çš„é”®åæ ¼å¼ï¼špondData_å¡˜å£_å¹´ä»½_æœˆä»½
        if (key.startsWith('pondData_')) {
          hasRecords = true;
          const parts = key.split('_');
          if (parts.length >= 4) {
            const pond = parts[1];
            const year = parts[2];
            const month = parts[3];
            
            const item = document.createElement('div');
            item.className = 'data-record-item';
            item.innerHTML = `
              <div class="record-info">
                <div>${pond}</div>
                <div class="record-date">${year}å¹´${month}æœˆ</div>
              </div>
              <button class="delete-btn" 
                      onclick="deleteSpecificRecord('${pond}', '${year}', '${month}')">
                <i class="fas fa-trash"></i> åˆ é™¤
              </button>
            `;
            listContainer.appendChild(item);
          }
        }
      }
      
      if (!hasRecords) {
        listContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #999;">æš‚æ— è®°å½•æ•°æ®</div>';
      }
    }

    // åˆ é™¤ç‰¹å®šè®°å½•
    function deleteSpecificRecord(pond = null, year = null, month = null) {
      // å¦‚æœå‚æ•°æœªæä¾›ï¼Œåˆ™ä»è¡¨å•è·å–
      if (!pond || !year || !month) {
        pond = document.getElementById('deletePondSelect').value;
        year = document.getElementById('deleteYearSelect').value;
        month = document.getElementById('deleteMonthSelect').value;
      }
      
      if (!pond || !year || !month) {
        showStatus('è¯·é€‰æ‹©è¦åˆ é™¤çš„å¡˜å£ã€å¹´ä»½å’Œæœˆä»½', 'warning');
        return;
      }
      
      const storageKey = `pondData_${pond}_${year}_${month}`;
      
      // æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
      if (!localStorage.getItem(storageKey)) {
        showStatus(`æœªæ‰¾åˆ° ${pond} ${year}å¹´${month}æœˆ çš„è®°å½•æ•°æ®`, 'warning');
        return;
      }
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤ ${pond} ${year}å¹´${month}æœˆ çš„è®°å½•æ•°æ®å—ï¼Ÿ`)) {
        // åˆ é™¤è®°å½•
        localStorage.removeItem(storageKey);
        
        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹çš„æ˜¯è¢«åˆ é™¤çš„è®°å½•ï¼Œåˆ·æ–°è¡¨æ ¼
        const currentPond = document.getElementById('pond').value;
        const currentYear = document.getElementById('recordYearSelect').value;
        const currentMonth = document.getElementById('recordMonthSelect').value;
        
        if (currentPond === pond && currentYear === year && currentMonth === month) {
          document.getElementById('tableBody').innerHTML = '';
          updateTableVisibility(false);
          currentData = null;
          showStatus('å½“å‰æŸ¥çœ‹çš„è®°å½•å·²è¢«åˆ é™¤', 'warning');
        }
        
        // æ›´æ–°è®°å½•åˆ—è¡¨
        loadDataRecordsList();
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        calculateStatistics();
        
        showStatus(`å·²åˆ é™¤ ${pond} ${year}å¹´${month}æœˆ çš„è®°å½•æ•°æ®`, 'success');
      }
    }

    // æ˜¾ç¤ºåˆ é™¤æ‰€æœ‰è®°å½•ç¡®è®¤æ¡†
    function showDeleteAllConfirm() {
      document.getElementById('deleteAllConfirmModal').classList.add('visible');
      document.getElementById('confirmDeleteText').value = '';
      document.getElementById('confirmDeleteText').focus();
    }

    // éšè—åˆ é™¤æ‰€æœ‰è®°å½•ç¡®è®¤æ¡†
    function hideDeleteAllConfirmModal() {
      document.getElementById('deleteAllConfirmModal').classList.remove('visible');
    }

    // åˆ é™¤æ‰€æœ‰è®°å½•
    function deleteAllRecords() {
      const confirmText = document.getElementById('confirmDeleteText').value.trim();
      
      if (confirmText !== 'DELETE') {
        showStatus('è¯·è¾“å…¥"DELETE"ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®', 'warning');
        return;
      }
      
      if (confirm('æœ€åç¡®è®¤ï¼šç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®°å½•æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        // éå†å¹¶åˆ é™¤æ‰€æœ‰è®°å½•æ•°æ®
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('pondData_')) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
        });
        
        // é‡ç½®å½“å‰è¡¨æ ¼
        document.getElementById('tableBody').innerHTML = '';
        updateTableVisibility(false);
        currentData = null;
        
        // æ›´æ–°è®°å½•åˆ—è¡¨
        loadDataRecordsList();
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        calculateStatistics();
        
        // éšè—ç¡®è®¤æ¡†
        hideDeleteAllConfirmModal();
        
        showStatus('æ‰€æœ‰è®°å½•æ•°æ®å·²åˆ é™¤', 'success');
      }
    }

    // ç»‘å®šå®æ—¶ç»Ÿè®¡äº‹ä»¶
    function bindRealTimeStatsEvents() {
      const statsControls = [
        'startYearSelect', 
        'startMonthSelect', 
        'endYearSelect', 
        'endMonthSelect', 
        'statsPondSelect'
      ];
      
      statsControls.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
          element.removeEventListener('change', handleStatsChange);
          // ç»‘å®šæ–°äº‹ä»¶
          element.addEventListener('change', handleStatsChange);
        }
      });
    }

    // ç»Ÿè®¡å˜åŒ–å¤„ç†å‡½æ•°
    function handleStatsChange() {
      // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è®¡ç®—
      clearTimeout(statsDebounceTimer);
      statsDebounceTimer = setTimeout(() => {
        showStatsLoading(true);
        calculateStatistics();
      }, 300);
    }

    // ç»‘å®šç»Ÿè®¡æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
    function bindStatsTabEvents() {
      const tabs = document.querySelectorAll('.stats-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.stats-tab-content').forEach(c => c.classList.remove('active'));
          
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          const content = document.getElementById(tabId);
          if (content) {
            content.classList.add('active');
          }
        });
      });
    }

    function handlePondChange() {
      updateCurrentDataInfo();
      const pond = document.getElementById('pond').value;
      if (pond) {
        autoLoadData();
      } else {
        document.getElementById('tableBody').innerHTML = '';
        updateTableVisibility(false);
        showStatus('è¯·é€‰æ‹©å¡˜å£æŸ¥çœ‹æ•°æ®', 'warning');
      }
    }

    function handleYearMonthChange() {
      updateCurrentDataInfo();
      const pond = document.getElementById('pond').value;
      if (pond) {
        autoLoadData();
      }
    }

    function updateCurrentDataInfo() {
      const pond = document.getElementById('pond').value || 'æœªé€‰æ‹©å¡˜å£';
      const year = document.getElementById('recordYearSelect').value;
      const month = document.getElementById('recordMonthSelect').value;
      
      document.getElementById('currentPondText').textContent = pond;
      document.getElementById('currentDateText').textContent = `${year}å¹´${month}æœˆ`;
    }

    function updateTableVisibility(hasData) {
      const table = document.getElementById('recordTable');
      const placeholder = document.getElementById('tablePlaceholder');
      
      if (hasData) {
        table.style.display = 'table';
        placeholder.style.display = 'none';
      } else {
        table.style.display = 'none';
        placeholder.style.display = 'block';
      }
    }

    function autoLoadData() {
      isLoading = true;
      const pond = document.getElementById('pond').value;
      const year = document.getElementById('recordYearSelect').value;
      const month = document.getElementById('recordMonthSelect').value;
      const storageKey = `pondData_${pond}_${year}_${month}`;
      const storedData = localStorage.getItem(storageKey);
      
      showStatus(`æ­£åœ¨åŠ è½½ ${pond} ${year}å¹´${month}æœˆ çš„æ•°æ®...`, 'success');
      
      setTimeout(() => {
        if (storedData) {
          const data = JSON.parse(storedData);
          currentData = data;
          document.getElementById('recorder').value = data.recorder || '';
          updateTableDays();
          updateTableVisibility(true);
          
          const keyPrefix = `${pond}_${year}_${month}`;
          if (data.lastModified) {
            lastModifiedTimes[keyPrefix] = data.lastModified;
          }
          
          setTimeout(() => {
            const days = getDaysInYearMonth(parseInt(year), parseInt(month));
            for (let day = 1; day <= days; day++) {
              const record = data.records?.[day] || {};
              document.querySelector(`.amount-input[data-day="${day}"][data-type="é¢—ç²’"]`).value = record.é¢—ç²’ || '';
              document.querySelector(`.amount-input[data-day="${day}"][data-type="è†¨åŒ–"]`).value = record.è†¨åŒ– || '';
              document.querySelector(`.amount-input[data-day="${day}"][data-type="å‘é…µ"]`).value = record.å‘é…µ || '';
              document.querySelector(`.amount-input[data-day="${day}"][data-type="ç²‰æ–™"]`).value = record.ç²‰æ–™ || '';
              document.querySelector(`.loss[data-day="${day}"]`).value = record.loss || '';
              document.querySelector(`.medicine[data-day="${day}"]`).value = record.medicine || '';
            }
            showStatus(`${pond} ${year}å¹´${month}æœˆ æ•°æ®åŠ è½½æˆåŠŸ`, 'success');
          }, 100);
        } else {
          updateTableDays();
          updateTableVisibility(true);
          showStatus(`${pond} ${year}å¹´${month}æœˆ æœªæ‰¾åˆ°å†å²è®°å½•ï¼Œå·²åˆå§‹åŒ–æ–°è¡¨æ ¼`, 'warning');
        }
        isLoading = false;
      }, 600);
    }

    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add(
        type === 'success' ? 'status-success' : 
        type === 'error' ? 'status-error' : 'status-warning'
      );
      statusElement.style.display = 'block';
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 5000);
    }

    function showAutoSaveIndicator() {
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.classList.add('visible');
      
      setTimeout(() => {
        indicator.classList.remove('visible');
      }, 2000);
    }

    function getDaysInYearMonth(year, month) {
      return new Date(year, month, 0).getDate();
    }

    function scheduleAutoSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      
      saveTimeout = setTimeout(() => {
        autoSaveData();
      }, 1000);
    }

    function autoSaveData() {
      const pond = document.getElementById('pond').value;
      const year = document.getElementById('recordYearSelect').value;
      const month = document.getElementById('recordMonthSelect').value;
      const recorder = document.getElementById('recorder').value;
      
      if (!pond) {
        showStatus('è¯·å…ˆé€‰æ‹©å¡˜å£', 'warning');
        return;
      }
      if (!recorder) {
        showStatus('è¯·å…ˆé€‰æ‹©è®°å½•äºº', 'warning');
        return;
      }
      
      const storageKey = `pondData_${pond}_${year}_${month}`;
      
      const data = {
        pond: pond,
        year: year,
        month: month,
        recorder: recorder,
        records: {},
        lastModified: {}
      };

      const days = getDaysInYearMonth(parseInt(year), parseInt(month));
      const keyPrefix = `${pond}_${year}_${month}`;
      
      for (let day = 1; day <= days; day++) {
        const é¢—ç²’ = document.querySelector(`.amount-input[data-day="${day}"][data-type="é¢—ç²’"]`).value;
        const è†¨åŒ– = document.querySelector(`.amount-input[data-day="${day}"][data-type="è†¨åŒ–"]`).value;
        const å‘é…µ = document.querySelector(`.amount-input[data-day="${day}"][data-type="å‘é…µ"]`).value;
        const ç²‰æ–™ = document.querySelector(`.amount-input[data-day="${day}"][data-type="ç²‰æ–™"]`).value;
        const loss = document.querySelector(`.loss[data-day="${day}"]`).value;
        const medicine = document.querySelector(`.medicine[data-day="${day}"]`).value;
        
        data.records[day] = {
          é¢—ç²’,
          è†¨åŒ–,
          å‘é…µ,
          ç²‰æ–™,
          loss,
          medicine
        };
        
        const now = new Date().toISOString();
        data.lastModified[day] = now;
        if (!lastModifiedTimes[keyPrefix]) lastModifiedTimes[keyPrefix] = {};
        lastModifiedTimes[keyPrefix][day] = now;
      }

      localStorage.setItem(storageKey, JSON.stringify(data));
      currentData = data;
      showAutoSaveIndicator();
      
      // å¦‚æœæ˜¯ç®¡ç†å‘˜ä¸”è®°å½•åˆ—è¡¨å·²æ˜¾ç¤ºï¼Œæ›´æ–°è®°å½•åˆ—è¡¨
      if (isAdminLoggedIn) {
        loadDataRecordsList();
      }
      
      // æ•°æ®å˜åŒ–åä¹Ÿæ›´æ–°ç»Ÿè®¡
      handleStatsChange();
    }

    function updateTableDays() {
      const pond = document.getElementById('pond').value;
      const year = parseInt(document.getElementById('recordYearSelect').value);
      const month = parseInt(document.getElementById('recordMonthSelect').value);
      const days = getDaysInYearMonth(year, month);

      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      const keyPrefix = `${pond}_${year}_${month}`;
      if (!lastModifiedTimes[keyPrefix]) {
        lastModifiedTimes[keyPrefix] = {};
      }

      for (let day = 1; day <= days; day++) {
        const row = document.createElement('tr');
        
        if (!lastModifiedTimes[keyPrefix][day]) {
          lastModifiedTimes[keyPrefix][day] = new Date().toISOString();
        }
        
        const isOldData = isMoreThanThreeDaysOld(
          new Date(lastModifiedTimes[keyPrefix][day]),
          new Date(year, month - 1, day)
        );

        const lockClass = isOldData ? 'edit-lock-tooltip' : '';
        const lockTooltip = isOldData ? 'è¿ç»­ç‚¹å‡»3æ¬¡å¯ç¼–è¾‘' : '';

        row.innerHTML = `
          <td><div class="day-number">${day}</div></td>
          <td>
            <input type="number" min="0" max="150" 
                   class="amount-input number-input ${lockClass}" 
                   data-day="${day}" 
                   data-type="é¢—ç²’" 
                   placeholder="æ•°" 
                   data-tooltip="${lockTooltip}"
                   oninput="scheduleAutoSave()"
                   onchange="scheduleAutoSave()"
                   onkeydown="handleFeedInputKeydown(event, ${day}, 'é¢—ç²’')">
          </td>
          <td>
            <input type="number" min="0" max="150" 
                   class="amount-input number-input ${lockClass}" 
                   data-day="${day}" 
                   data-type="è†¨åŒ–" 
                   placeholder="æ•°" 
                   data-tooltip="${lockTooltip}"
                   oninput="scheduleAutoSave()"
                   onchange="scheduleAutoSave()"
                   onkeydown="handleFeedInputKeydown(event, ${day}, 'è†¨åŒ–')">
          </td>
          <td>
            <input type="number" min="0" max="20" 
                   class="amount-input number-input ${lockClass}" 
                   data-day="${day}" 
                   data-type="å‘é…µ" 
                   placeholder="æ•°" 
                   data-tooltip="${lockTooltip}"
                   oninput="scheduleAutoSave()"
                   onchange="scheduleAutoSave()"
                   onkeydown="handleFeedInputKeydown(event, ${day}, 'å‘é…µ')">
          </td>
          <td>
            <input type="number" min="0" max="150" 
                   class="amount-input number-input ${lockClass}" 
                   data-day="${day}" 
                   data-type="ç²‰æ–™" 
                   placeholder="æ•°" 
                   data-tooltip="${lockTooltip}"
                   oninput="scheduleAutoSave()"
                   onchange="scheduleAutoSave()"
                   onkeydown="handleFeedInputKeydown(event, ${day}, 'ç²‰æ–™')">
          </td>
          <td>
            <textarea class="loss-input loss ${lockClass}" 
                      data-day="${day}" 
                      placeholder="ä¾‹å¦‚ï¼š2æ¡è‰é±¼ï¼Œç¼ºæ°§" 
                      data-tooltip="${lockTooltip}"
                      oninput="scheduleAutoSave()"
                      onchange="scheduleAutoSave()"></textarea>
          </td>
          <td>
            <textarea class="medicine-input medicine ${lockClass}" 
                      data-day="${day}" 
                      placeholder="ä¾‹å¦‚ï¼šç”ŸçŸ³ç°ï¼Œ5kgï¼Œå…¨å¡˜æ³¼æ´’" 
                      data-tooltip="${lockTooltip}"
                      oninput="scheduleAutoSave()"
                      onchange="scheduleAutoSave()"></textarea>
          </td>
        `;
        tableBody.appendChild(row);
      }

      bindInputClickEvents(keyPrefix);
    }

    // å¤„ç†é¥²æ–™è¾“å…¥æ¡†çš„é”®ç›˜äº‹ä»¶
    function handleFeedInputKeydown(event, day, type) {
      // Enteré”®åˆ‡æ¢è‡³æ¬¡æ—¥åŒä¸€é¥²æ–™ç±»å‹
      if (event.key === 'Enter') {
        event.preventDefault();
        const nextDay = day + 1;
        const maxDay = getDaysInYearMonth(
          parseInt(document.getElementById('recordYearSelect').value),
          parseInt(document.getElementById('recordMonthSelect').value)
        );
        if (nextDay <= maxDay) {
          const nextInput = document.querySelector(`.amount-input[data-day="${nextDay}"][data-type="${type}"]`);
          if (nextInput) nextInput.focus();
        }
      }
      // Escé”®æ¸…ç©ºå½“å‰è¾“å…¥
      else if (event.key === 'Escape') {
        event.target.value = '';
        scheduleAutoSave();
      }
    }

    function bindInputClickEvents(keyPrefix) {
      const inputs = document.querySelectorAll('#tableBody input, #tableBody textarea');
      inputs.forEach(input => {
        input.addEventListener('click', function(e) {
          const day = this.getAttribute('data-day');
          const type = this.getAttribute('data-type') || 'text';
          const inputKey = `${keyPrefix}-${day}-${type}`;
          const year = parseInt(document.getElementById('recordYearSelect').value);
          const month = parseInt(document.getElementById('recordMonthSelect').value);
          
          const isOldData = isMoreThanThreeDaysOld(
            new Date(lastModifiedTimes[keyPrefix][day]),
            new Date(year, month - 1, day)
          );

          // ç®¡ç†å‘˜ä¸å—ç¼–è¾‘é™åˆ¶
          if (isOldData && !isAdminLoggedIn) {
            editClickCount[inputKey] = (editClickCount[inputKey] || 0) + 1;
            
            if (editClickCount[inputKey] < 3) {
              e.preventDefault();
              e.stopPropagation();
              this.blur();
              showStatus(`è¯·å†ç‚¹å‡» ${3 - editClickCount[inputKey]} æ¬¡ä»¥ç¼–è¾‘å†å²æ•°æ®`, 'warning');
            } else {
              editClickCount[inputKey] = 0;
              showStatus('å·²è§£é”ç¼–è¾‘æƒé™', 'success');
            }
          }
        });
      });
    }

    function isMoreThanThreeDaysOld(lastModified, recordDate) {
      const recordMidnight = new Date(recordDate);
      recordMidnight.setHours(23, 59, 59, 999);
      
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      // ç®¡ç†å‘˜ä¸å—æ­¤é™åˆ¶
      return isAdminLoggedIn ? false : recordMidnight < threeDaysAgo;
    }

    function exportToExcel() {
      document.getElementById('exportLoading').style.display = 'block';
      
      try {
        if (typeof XLSX === 'undefined') {
          throw new Error('å¯¼å‡ºåŠŸèƒ½ä¾èµ–çš„åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
        
        if (!currentData) {
          throw new Error('æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©å¡˜å£å¹¶åŠ è½½æ•°æ®');
        }
        
        const { pond, year, month } = currentData;
        
        if (!pond || !year || !month) {
          throw new Error('æ•°æ®ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•å¯¼å‡º');
        }
        
        const days = getDaysInYearMonth(parseInt(year), parseInt(month));
        const wsData = [
          [`${pond} ${year}å¹´${month}æœˆé±¼å¡˜å…»æ®–è®°å½•`, '', '', '', '', '', ''],
          [`è®°å½•äººï¼š${currentData.recorder || 'æœªå¡«å†™'}`, '', '', '', '', '', ''],
          [`å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}`, '', '', '', '', '', ''],
          ['', '', '', '', '', '', ''],
          ['æ—¥æœŸ', 'é¢—ç²’(åŒ…)', 'è†¨åŒ–(åŒ…)', 'å‘é…µ(åŒ…)', 'ç²‰æ–™(åŒ…)', 'æŸè€—', 'ç”¨è¯è®°å½•']
        ];
        
        for (let day = 1; day <= days; day++) {
          const é¢—ç²’ = document.querySelector(`.amount-input[data-day="${day}"][data-type="é¢—ç²’"]`).value || '';
          const è†¨åŒ– = document.querySelector(`.amount-input[data-day="${day}"][data-type="è†¨åŒ–"]`).value || '';
          const å‘é…µ = document.querySelector(`.amount-input[data-day="${day}"][data-type="å‘é…µ"]`).value || '';
          const ç²‰æ–™ = document.querySelector(`.amount-input[data-day="${day}"][data-type="ç²‰æ–™"]`).value || '';
          const loss = document.querySelector(`.loss[data-day="${day}"]`).value || '';
          const medicine = document.querySelector(`.medicine[data-day="${day}"]`).value || '';
          
          wsData.push([
            day,
            é¢—ç²’,
            è†¨åŒ–,
            å‘é…µ,
            ç²‰æ–™,
            loss,
            medicine
          ]);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wscols = [
          {wch: 6},  // æ—¥æœŸ
          {wch: 10},  // é¢—ç²’
          {wch: 10},  // è†¨åŒ–
          {wch: 10},  // å‘é…µ
          {wch: 10},  // ç²‰æ–™
          {wch: 20}, // æŸè€—
          {wch: 30}  // ç”¨è¯è®°å½•
        ];
        ws['!cols'] = wscols;
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'å…»æ®–è®°å½•');
        
        const fileName = `${pond}_${year}å¹´${month}æœˆè®°å½•.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        let successMsg = `å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åä¸ºï¼š${fileName}`;
        if (isMobile) {
          successMsg += '\næ–‡ä»¶å·²ä¿å­˜åˆ°"ä¸‹è½½"æ–‡ä»¶å¤¹ï¼Œå¯é€šè¿‡æ–‡ä»¶ç®¡ç†APPæŸ¥æ‰¾';
        }
        showStatus(successMsg, 'success');
        
      } catch (error) {
        showStatus(`å¯¼å‡ºå¤±è´¥ï¼š${error.message}`, 'error');
        console.error('å¯¼å‡ºé”™è¯¯:', error);
      } finally {
        document.getElementById('exportLoading').style.display = 'none';
      }
    }

    // æ˜¾ç¤º/éšè—ç»Ÿè®¡åŠ è½½æç¤º
    function showStatsLoading(show) {
      const loading = document.getElementById('statsLoading');
      if (loading) {
        loading.style.display = show ? 'block' : 'none';
      }
    }

    // å®æ—¶ç»Ÿè®¡å‡½æ•°
    function calculateStatistics() {
      const statsPond = document.getElementById('statsPondSelect').value;
      const startYear = parseInt(document.getElementById('startYearSelect').value);
      const startMonth = parseInt(document.getElementById('startMonthSelect').value);
      const endYear = parseInt(document.getElementById('endYearSelect').value);
      const endMonth = parseInt(document.getElementById('endMonthSelect').value);

      // éªŒè¯æ—¶é—´èŒƒå›´
      if (startYear > endYear || (startYear === endYear && startMonth > endMonth)) {
        showStatus('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´', 'error');
        showStatsLoading(false);
        return;
      }

      // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
      const stats = {
        totalFeeds: { é¢—ç²’: 0, è†¨åŒ–: 0, å‘é…µ: 0, ç²‰æ–™: 0, total: 0 },
        loss: {
          byBreed: {},       // æŒ‰é±¼ç±»å“ç§ç»Ÿè®¡
          byPondBreed: {},   // æŒ‰å¡˜å£-é±¼ç±»å“ç§ç»Ÿè®¡
          byPondTotal: {}    // å„å¡˜å£æ€»æŸè€—
        },
        pondFeeds: {},       // å„å¡˜å£é¥²æ–™ç”¨é‡
        monthly: [],
        totalMedicineCount: 0,
        totalLossCount: 0
      };

      // å®šä¹‰æ‰€æœ‰é±¼å“ç§
      const fishBreeds = ['è‰é±¼', 'é²«é±¼', 'é®°é±¼', 'é»„é‡‘é²«', 'ä¹Œé’', 'èŠ±é²¢', 'ç™½é²¢', 'é²»é±¼', 'è™¾'];

      // è·å–æ‰€æœ‰å¡˜å£åˆ—è¡¨
      const allPonds = Array.from(document.querySelectorAll('#pond option'))
        .filter(option => option.value)
        .map(option => option.value);
      
      // ç­›é€‰éœ€è¦ç»Ÿè®¡çš„å¡˜å£
      const targetPonds = statsPond ? [statsPond] : allPonds;

      // åˆå§‹åŒ–å¡˜å£æ•°æ®ç»“æ„
      targetPonds.forEach(pond => {
        stats.pondFeeds[pond] = { é¢—ç²’: 0, è†¨åŒ–: 0, å‘é…µ: 0, ç²‰æ–™: 0, total: 0 };
        
        // åˆå§‹åŒ–æŸè€—ç»Ÿè®¡ç»“æ„ï¼ˆæŒ‰å¡˜å£-é±¼å“ç§ï¼‰
        stats.loss.byPondBreed[pond] = {};
        fishBreeds.forEach(breed => {
          stats.loss.byPondBreed[pond][breed] = 0; // åˆå§‹åŒ–æ¯ä¸ªå¡˜å£çš„æ¯ç§é±¼æŸè€—ä¸º0
        });
        stats.loss.byPondTotal[pond] = 0; // å¡˜å£æ€»æŸè€—
      });

      // éå†æ—¶é—´æ®µå†…çš„æ‰€æœ‰æœˆä»½
      let currentY = startYear;
      let currentM = startMonth;
      
      while (true) {
        targetPonds.forEach(pond => {
          const storageKey = `pondData_${pond}_${currentY}_${currentM}`;
          const monthData = localStorage.getItem(storageKey);
          const daysInMonth = getDaysInYearMonth(currentY, currentM);
          const monthlyKey = `${pond}_${currentY}_${currentM}`;
          
          // åˆå§‹åŒ–æœˆåº¦ç»Ÿè®¡
          if (!stats.monthly.find(item => item.key === monthlyKey)) {
            stats.monthly.push({
              key: monthlyKey,
              month: `${currentY}å¹´${currentM}æœˆ`,
              pond: pond,
              totalFeed: 0,
              avgDailyFeed: 0,
              totalLoss: 0,
              medicineCount: 0
            });
          }
          const monthStats = stats.monthly.find(item => item.key === monthlyKey);

          if (monthData) {
            const data = JSON.parse(monthData);
            for (let day = 1; day <= daysInMonth; day++) {
              const dayRecord = data.records?.[day] || {};
              
              // 1. é¥²æ–™ç»Ÿè®¡ï¼ˆæŒ‰å¡˜å£-ç§ç±»ï¼‰
              const é¢—ç²’ = parseInt(dayRecord.é¢—ç²’ || 0);
              const è†¨åŒ– = parseInt(dayRecord.è†¨åŒ– || 0);
              const å‘é…µ = parseInt(dayRecord.å‘é…µ || 0);
              const ç²‰æ–™ = parseInt(dayRecord.ç²‰æ–™ || 0);
              
              // ç´¯åŠ æ€»ç»Ÿè®¡
              stats.totalFeeds.é¢—ç²’ += é¢—ç²’;
              stats.totalFeeds.è†¨åŒ– += è†¨åŒ–;
              stats.totalFeeds.å‘é…µ += å‘é…µ;
              stats.totalFeeds.ç²‰æ–™ += ç²‰æ–™;
              
              // ç´¯åŠ å¡˜å£ç»Ÿè®¡
              stats.pondFeeds[pond].é¢—ç²’ += é¢—ç²’;
              stats.pondFeeds[pond].è†¨åŒ– += è†¨åŒ–;
              stats.pondFeeds[pond].å‘é…µ += å‘é…µ;
              stats.pondFeeds[pond].ç²‰æ–™ += ç²‰æ–™;
              
              // ç´¯åŠ æœˆåº¦ç»Ÿè®¡
              monthStats.totalFeed += é¢—ç²’ + è†¨åŒ– + å‘é…µ + ç²‰æ–™;

              // 2. æŸè€—ç»Ÿè®¡ï¼ˆæŒ‰å¡˜å£-é±¼ç±»ç§ç±»ï¼‰
              if (dayRecord.loss) {
                const lossInfo = parseLossRecord(dayRecord.loss);
                lossInfo.forEach(item => {
                  // åŒ¹é…æ ‡å‡†é±¼å“ç§ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
                  const matchedBreed = fishBreeds.find(breed => 
                    item.breed.includes(breed) || breed.includes(item.breed)
                  );
                  
                  if (matchedBreed) {
                    // æ€»é±¼ç±»æŸè€—ç»Ÿè®¡
                    if (!stats.loss.byBreed[matchedBreed]) {
                      stats.loss.byBreed[matchedBreed] = { 
                        count: 0, 
                        reasons: {},
                        ponds: new Set() // æ¶‰åŠçš„å¡˜å£
                      };
                    }
                    stats.loss.byBreed[matchedBreed].count += item.count;
                    stats.loss.byBreed[matchedBreed].ponds.add(pond);
                    stats.totalLossCount += item.count;
                    monthStats.totalLoss += item.count;
                    stats.loss.byPondTotal[pond] += item.count;
                    
                    // å¡˜å£-é±¼ç±»æŸè€—ç»Ÿè®¡
                    stats.loss.byPondBreed[pond][matchedBreed] += item.count;
                    
                    // è®°å½•æŸè€—åŸå› 
                    if (item.reason) {
                      if (!stats.loss.byBreed[matchedBreed].reasons[item.reason]) {
                        stats.loss.byBreed[matchedBreed].reasons[item.reason] = 0;
                      }
                      stats.loss.byBreed[matchedBreed].reasons[item.reason]++;
                    }
                  }
                });
              }

              // 3. ç”¨è¯è®°å½•ç»Ÿè®¡
              if (dayRecord.medicine) {
                monthStats.medicineCount++;
                stats.totalMedicineCount++;
              }
            }
          }

          // è®¡ç®—æœˆå¹³å‡æŠ•å–‚é‡
          monthStats.avgDailyFeed = monthStats.totalFeed > 0 
            ? (monthStats.totalFeed / daysInMonth).toFixed(1) 
            : 0;
        });

        // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæœˆ
        if (currentY === endYear && currentM === endMonth) break;
        currentM++;
        if (currentM > 12) {
          currentM = 1;
          currentY++;
        }
      }

      // è®¡ç®—æ€»è®¡
      stats.totalFeeds.total = stats.totalFeeds.é¢—ç²’ + stats.totalFeeds.è†¨åŒ– + 
                             stats.totalFeeds.å‘é…µ + stats.totalFeeds.ç²‰æ–™;
      
      // è®¡ç®—å„å¡˜å£é¥²æ–™æ€»è®¡
      targetPonds.forEach(pond => {
        stats.pondFeeds[pond].total = stats.pondFeeds[pond].é¢—ç²’ + stats.pondFeeds[pond].è†¨åŒ– +
                                    stats.pondFeeds[pond].å‘é…µ + stats.pondFeeds[pond].ç²‰æ–™;
      });

      // æ¸²æŸ“ç»Ÿè®¡ç»“æœ
      renderStatistics(stats, targetPonds, fishBreeds);
      
      // éšè—åŠ è½½æç¤º
      showStatsLoading(false);
    }

    function parseLossRecord(lossText) {
      const result = [];
      const lossRegex = /(\d+)\s*([æ¡åªå¤´å°¾æ–¤å…¬æ–¤])\s*([^ï¼Œ,]+?)(?:[ï¼Œ,]\s*(.+?))?(?:[ï¼›;]|$)/g;
      let match;
      
      while ((match = lossRegex.exec(lossText)) !== null) {
        result.push({
          count: parseInt(match[1]),
          unit: match[2].trim(),
          breed: match[3].trim(),
          reason: match[4]?.trim() || ''
        });
      }
      
      if (result.length === 0 && lossText.trim()) {
        result.push({
          count: 1,
          unit: 'ä¸ª',
          breed: 'å…¶ä»–',
          reason: lossText.trim()
        });
      }
      
      return result;
    }

    // æ¸²æŸ“ç»Ÿè®¡ç»“æœ
    function renderStatistics(stats, targetPonds, fishBreeds) {
      // 1. æŠ•å–‚é‡æ±‡æ€»
      const totalStatsBody = document.getElementById('totalStatsBody');
      if (totalStatsBody) {
        totalStatsBody.innerHTML = `
          <tr>
            <td>æ€»æŠ•å–‚é‡</td>
            <td>${stats.totalFeeds.é¢—ç²’}</td>
            <td>${stats.totalFeeds.è†¨åŒ–}</td>
            <td>${stats.totalFeeds.å‘é…µ}</td>
            <td>${stats.totalFeeds.ç²‰æ–™}</td>
            <td>${stats.totalFeeds.total}</td>
          </tr>
          <tr>
            <td>å æ¯”</td>
            <td>${calculatePercentage(stats.totalFeeds.é¢—ç²’, stats.totalFeeds.total)}</td>
            <td>${calculatePercentage(stats.totalFeeds.è†¨åŒ–, stats.totalFeeds.total)}</td>
            <td>${calculatePercentage(stats.totalFeeds.å‘é…µ, stats.totalFeeds.total)}</td>
            <td>${calculatePercentage(stats.totalFeeds.ç²‰æ–™, stats.totalFeeds.total)}</td>
            <td>100%</td>
          </tr>
        `;
      }

      // 2. æŒ‰å¡˜å£-é¥²æ–™ç§ç±»ç»Ÿè®¡
      const pondFeedTypeBody = document.getElementById('pondFeedTypeBody');
      if (pondFeedTypeBody) {
        pondFeedTypeBody.innerHTML = '';
        
        if (targetPonds.length === 0) {
          pondFeedTypeBody.innerHTML = '<tr><td>æš‚æ— æ•°æ®</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>';
        } else {
          targetPonds.forEach(pond => {
            const feed = stats.pondFeeds[pond];
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${pond}</td>
              <td>${feed.é¢—ç²’}</td>
              <td>${feed.è†¨åŒ–}</td>
              <td>${feed.å‘é…µ}</td>
              <td>${feed.ç²‰æ–™}</td>
              <td>${feed.total}</td>
            `;
            pondFeedTypeBody.appendChild(row);
          });
        }
      }

      // 3. é±¼ç±»æŸè€—æ€»ç»Ÿè®¡
      const lossByBreedBody = document.getElementById('lossByBreedBody');
      if (lossByBreedBody) {
        lossByBreedBody.innerHTML = '';
        
        if (Object.keys(stats.loss.byBreed).length === 0) {
          lossByBreedBody.innerHTML = '<tr><td>æš‚æ— æ•°æ®</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>';
        } else {
          Object.entries(stats.loss.byBreed).forEach(([breed, info]) => {
            const mainReason = info.reasons ? Object.entries(info.reasons).sort((a,b)=>b[1]-a[1])[0]?.[0] : 'æœªè®°å½•';
            const ponds = Array.from(info.ponds).join('ã€');
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${breed}</td>
              <td>${info.count}</td>
              <td>${mainReason}</td>
              <td>${stats.totalLossCount > 0 ? ((info.count / stats.totalLossCount) * 100).toFixed(1) + '%' : '0%'}</td>
              <td>${ponds || 'æœªçŸ¥'}</td>
            `;
            lossByBreedBody.appendChild(row);
          });
        }
      }

      // 4. æŒ‰å¡˜å£-é±¼ç±»ç§ç±»æŸè€—ç»Ÿè®¡
      const pondLossTypeBody = document.getElementById('pondLossTypeBody');
      if (pondLossTypeBody) {
        pondLossTypeBody.innerHTML = '';
        
        if (targetPonds.length === 0) {
          pondLossTypeBody.innerHTML = '<tr><td>æš‚æ— æ•°æ®</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>';
        } else {
          targetPonds.forEach(pond => {
            const row = document.createElement('tr');
            let totalLoss = 0;
            
            // è®¡ç®—è¯¥å¡˜å£æ€»æŸè€—
            fishBreeds.forEach(breed => {
              totalLoss += stats.loss.byPondBreed[pond][breed] || 0;
            });
            
            // æ„å»ºè¡¨æ ¼è¡Œå†…å®¹
            row.innerHTML = `
              <td>${pond}</td>
              ${fishBreeds.map(breed => `<td>${stats.loss.byPondBreed[pond][breed] || 0}</td>`).join('')}
              <td><strong>${totalLoss}</strong></td>
            `;
            pondLossTypeBody.appendChild(row);
          });
        }
      }

      // 5. æœˆåº¦æ˜ç»†
      const monthlyStatsBody = document.getElementById('monthlyStatsBody');
      if (monthlyStatsBody) {
        monthlyStatsBody.innerHTML = '';
        
        if (stats.monthly.length === 0) {
          monthlyStatsBody.innerHTML = '<tr><td>æš‚æ— æ•°æ®</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>';
        } else {
          stats.monthly.forEach(month => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${month.month}<br><small>${month.pond}</small></td>
              <td>${month.totalFeed}</td>
              <td>${month.avgDailyFeed}</td>
              <td>${month.totalLoss}</td>
              <td>${month.medicineCount}</td>
            `;
            monthlyStatsBody.appendChild(row);
          });
        }
      }
    }

    function calculatePercentage(value, total) {
      if (total === 0) return '0%';
      return ((value / total) * 100).toFixed(1) + '%';
    }
  </script>
</body>
 <!-- ===== ä¸€é”®ä¿å­˜å¼€å§‹ ===== -->
 <script src="https://cdn.jsdelivr.net/npm/@octokit/rest/dist/octokit-rest.min.js"></script>
 <script>
 /* ========== åªéœ€æ”¹è¿™é‡Œ 3 è¡Œ ========== */
 const TOKEN  = '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';     // æŠŠåˆšæ‰å¤åˆ¶çš„ token ç²˜è¿›æ¥
 const OWNER  = 'sunhua224ytgl';   // ä¾‹å¦‚ fishboss
 const REPO   = 'sunhua1224ytgl';        // ä¾‹å¦‚ fish-farm
 /* ===================================== */
 
 const FILE   = 'data.json';  // ä¿å­˜æ•°æ®çš„æ–‡ä»¶å
 const octokit = new Octokit({ auth: TOKEN });
 
 // æŠŠè¡¨æ ¼æ‰€æœ‰ input çš„å€¼æ‰“åŒ…æˆ json
 function collectData() {
   const data = {};
   document.querySelectorAll('#fishTable input, #fishTable select').forEach(el => {
     data[el.name || el.id] = el.value;
   });
   return data;
 }
 
 // ä¸€é”®ä¿å­˜æŒ‰é’®
 document.body.insertAdjacentHTML('beforeend',
   `<div style="text-align:center;margin:20px">
      <button id="saveBtn" style="padding:10px 30px;font-size:18px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer">ä¸€é”®åŒæ­¥åˆ° GitHub</button>
      <p id="msg" style="margin-top:10px;color:#333"></p >
    </div>`);
 
 document.getElementById('saveBtn').onclick = async () => {
   const msgBox = document.getElementById('msg');
   msgBox.textContent = 'ä¿å­˜ä¸­...';
   try {
     // è¯»æ—§æ–‡ä»¶ï¼ˆä¸ºäº†æ‹¿åˆ° shaï¼‰
     const { data: oldFile } = await octokit.repos.getContent({ owner: OWNER, repo: REPO, path: FILE });
     await octokit.repos.createOrUpdateFileContents({
       owner: OWNER, repo: REPO, path: FILE,
       message: 'æ›´æ–°é±¼å¡˜æ•°æ® ' + new Date().toLocaleString('zh-CN'),
       content: btoa(JSON.stringify(collectData(), null, 2)),
       sha: oldFile.sha
     });
     msgBox.textContent = 'âœ… å·²ä¿å­˜ï¼Œè¯·ç­‰ 30 ç§’ååˆ·æ–°é¡µé¢æŸ¥çœ‹';
   } catch (e) {
     // å¦‚æœ data.json ä¸å­˜åœ¨ï¼Œå°±æ–°å»º
     await octokit.repos.createOrUpdateFileContents({
       owner: OWNER, repo: REPO, path: FILE,
       message: 'æ–°å»ºé±¼å¡˜æ•°æ® ' + new Date().toLocaleString('zh-CN'),
       content: btoa(JSON.stringify(collectData(), null, 2))
     });
     msgBox.textContent = 'âœ… å·²æ–°å»ºå¹¶ä¿å­˜ï¼Œè¯·ç­‰ 30 ç§’ååˆ·æ–°é¡µé¢æŸ¥çœ‹';
   }
 };
 </script>
 <!-- ===== ä¸€é”®ä¿å­˜ç»“æŸ ===== -->
</html>
